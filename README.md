# OTUS_backup
backup_lab

### Настраиваем бэкапы

Настроить стенд Vagrant с двумя виртуальными машинами: backup_server и client

Настроить удаленный бекап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:

    Директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB.
    Репозиторий дле резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение
    Имя бекапа должно содержать информацию о времени снятия бекапа
    Глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов
    Резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации.
    Написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение.


### Файлы: 
`BackupScript.sh` - основной скрипт бэкапа (по ТЗ - Глубина бекапа год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день + настроена политика удаления старых бэкапов)


`authorized_keys` - публичный ключ копируемый на сервер для доступа по ssh и borg'a


`client_script.sh` - подготовка лабы для клиента


`hosts` - резолвинг клиента/сервера


`id_rsa` - приватный ключ, хранится на клиенте 


`id_rsa.pub` - публичный ключ, остается на клиенте


`server_script.sh` - подготовка лабы для сервера

### Выполнение: 
Развернуты две ВМ - `client 10.0.1.4` и `server 10.0.1.5`


На обоих серверах установлен borg и создан пользователь **borg**


`useradd -m borg`

На клиенте сгенерирован ssh-ключ:
`ssh-keygen`

Копируем публичный ключ на сервер для пользователя `borg`.


Иницализируем бэкап репозиторий на server с client:
```
borg init --encryption=repokey borg@server:/var/backup/borg
```

Пароль - `borg`. Его же определяем в переменной окружения для использования в скрипте `BackupScript.sh`.

Запускаем бэкап:
borg create --stats --list borg@192.168.11.101:/var/backup/::"MyBackup-{now:%Y-%m-%d_%H:%M:%S}" /etc
Теперь проверяем репо с backupserver:
borg list /var/backup


