# OTUS_backup
backup_lab

### Настраиваем бэкапы

Настроить стенд Vagrant с двумя виртуальными машинами: backup_server и client

Настроить удаленный бекап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:

    Директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB.
    Репозиторий дле резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение
    Имя бекапа должно содержать информацию о времени снятия бекапа
    Глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов
    Резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации.
    Написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение.


### Файлы: 
`BackupScript.sh` - основной скрипт бэкапа (по ТЗ - Глубина бекапа год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день + настроена политика удаления старых бэкапов)


`client_script.sh` - скрипт разворачивающий лабу для клиента


`server_script.sh` - скрипт разворачивающий лабу для сервера


`hosts` - резолвинг клиента/сервера


`authorized_keys` - публичный ключ копируемый на сервер для доступа по ssh и borg'a


`id_rsa` - приватный ключ, хранится на клиенте 


`id_rsa.pub` - публичный ключ, остается на клиенте


### Выполнение: 
Развернуты две ВМ - `client 10.0.1.4` и `server 10.0.1.5`


На обоих серверах установлен borg и создан пользователь **borg**


`useradd -m borg`

На клиенте сгенерирован ssh-ключ:
`ssh-keygen`

Копируем публичный ключ на сервер для пользователя `borg`.


Иницализируем бэкап репозиторий на server с client:
```
[borg@client .ssh]$ borg init --encryption=repokey borg@server:/var/backup/borg

```

Пароль - `borg`. Его же определяем в переменной окружения для использования в скрипте `BackupScript.sh`.

Запускаем бэкап:
```
[borg@client .ssh]$ borg create -v --stats borg@server:/var/backup/borg::'Backup-{now:%Y-%m-%d@%H:%M}' /etc

------------------------------------------------------------------------------
Archive name: Backup-2021-04-28@23:03
Archive fingerprint: 0da696da0c4303fa40cf0a22ac80329027f54b03c61d3466a91fbe54d4566807
Time (start): Wed, 2021-04-28 23:03:17
Time (end):   Wed, 2021-04-28 23:03:18
Duration: 1.03 seconds
Number of files: 359
Utilization of max. archive size: 0%
------------------------------------------------------------------------------
                       Original size      Compressed size    Deduplicated size
This archive:               21.00 MB              8.03 MB              8.02 MB
All archives:               21.00 MB              8.03 MB              8.02 MB

                       Unique chunks         Total chunks
Chunk index:                     352                  360
------------------------------------------------------------------------------

```

Проверим бэкапы на сервере:
```
borg list /var/backup

[borg@server vagrant]$ borg list /var/backup/borg/
Enter passphrase for key /var/backup/borg: 
Backup-2021-04-28@23:03              Wed, 2021-04-28 23:03:17 [0da696da0c4303fa40cf0a22ac80329027f54b03c61d3466a91fbe54d4566807]
```

Бэкап выполнен. Далее добавляем задачу в `cron` (Выполнение от пользователя `borg`): 
```
*/5 * * * * runuser -l borg -c /opt/BackupScript.sh > /dev/null 2>&1
```

Проверим что бэкапы работают, удалим на клиента файл /etc/
